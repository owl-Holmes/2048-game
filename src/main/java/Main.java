package main.java;

import javafx.application.Application;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.ImageCursor;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.image.Image;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.layout.BorderPane;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.StackPane;
import javafx.stage.Stage;
import main.java.game2048.board.GameBoard;


import java.io.*;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;


/**
 * Main class for the {@code 2048} game.
 * <p>
 * This class initializes the primary stage and scene, handles user input,
 * updates the game board UI, and manages persistence of the best score.
 * It connects the GUI elements with the underlying game logic encapsulated
 * in {@link GameBoard}. All of that forms the {@code 2048} game with its graphics and playability.
 * </p>
 *
 * <p><b>Responsibilities:</b></p>
 * <ul>
 *   <li>Setup and style JavaFX UI components (grid, buttons, labels)</li>
 *   <li>Handle keyboard events to move tiles</li>
 *   <li>Manage and persist best score data</li>
 *   <li>Update tile colors and labels according to game state</li>
 *   <li>Allow the player to play</li>
 * </ul>
 *
 * A little lookup of what the interface have to look
 * <pre>
 * +-------------------------------------------------+
 * | New game                Score: 0  Best score: 0 |
 * |                                                 |
 * +-------------------------------------------------+
 * |  [   0] [   0] [   0] [   0]                    |
 * |  [   0] [   2] [   0] [   0]                    |
 * |  [   0] [   0] [   0] [   0]                    |
 * |  [   0] [   0] [   2] [   0]                    |
 * +-------------------------------------------------+
 * </pre>
 *
 * <p><b>Thread Safety:</b> This class is confined to the JavaFX 21 Application Thread.</p>
 *
 * @author owl
 */
public class Main extends Application {

    /**
     * Maps tile values to their corresponding background color hex codes
     * <p>
     * Values beyond {@code 2048} generate colors dynamically based on logarithmic scale.
     * </p>
     *
     * @param value the tile numeric value
     * @return hex string representing the background color for the tile
     */
    private String getBackgroundColor(int value) {
        return switch (value) {
            case 0 -> "#CDC1B4";
            case 2 -> "#EEE4DA";
            case 4 -> "#EDE0C8";
            case 8 -> "#F2B179";
            case 16 -> "#F59563";
            case 32 -> "#F67C5F";
            case 64 -> "#F65E3B";
            case 128 -> "#EDCF72";
            case 256 -> "#EDCC61";
            case 512 -> "#EDC850";
            case 1024 -> "#EDC53F";
            case 2048 -> "#EDC22E";
            default ->  String.format(
                    "#%06X",
                    (0x97ceff + (int)(Math.log(value) / Math.log(2)) * 2 ) & 0xFFFFFF
            );
        };
    }

    /**
     * Application entry point.
     *
     * @param args command-line arguments
     */
    public static void main(String[] args) {
        launch(args);
    }

    /**
     * Initializes the JavaFX primary stage and scene, sets up UI components,
     * binds event handlers, and loads persistent data (best score).
     * <p>
     * The method builds the game grid, score labels, buttons,
     * and handles key press events to shift tiles accordingly.
     * </p>
     *
     * @param primaryStage the primary window stage for this application
     * @throws IOException if an error occurs while loading resources (e.g., cursor images or best score file)
     */
    @Override
    public void start(Stage primaryStage) throws IOException {


        // Root layout container with styling applied
        BorderPane mainLayout = new BorderPane();
        StackPane root = new StackPane(mainLayout);
        root.getStyleClass().add("root-pane");

        // Initialize the scene and attach CSS stylesheet
        Scene gameScene = new Scene(root);
        gameScene.getStylesheets().add(getClass().getResource("/style/style.css").toExternalForm());
        // Ensure the root has keyboard focus to receive key events
        gameScene.getRoot().requestFocus();

        // Configure primary stage properties
        primaryStage.setScene(gameScene);
        primaryStage.setTitle("2048");
        primaryStage.setWidth(500);
        primaryStage.setHeight(450);
        primaryStage.setResizable(false);
        primaryStage.show();

        //--------------------------------------------------------------------------------------------------------------

        // Load custom cursors for UI interaction feedback
        ImageCursor defaultCursor = new ImageCursor(new Image(new FileInputStream("resources/images/cursor.png")));
        ImageCursor hoverCursor = new ImageCursor(new Image(new FileInputStream("resources/images/cursor2.png")));
        gameScene.setCursor(defaultCursor);

        //--------------------------------------------------------------------------------------------------------------

        // Instantiate game logic and best score tracking
        GameBoard gameBoard = new GameBoard();
        AtomicInteger bestScore = new AtomicInteger();

        // Attempt to load persisted best score from file
        try (BufferedReader reader = new BufferedReader(new FileReader("resources/data/best_score.txt"))) {
            String line = reader.readLine();
            if (line != null) bestScore.set(Integer.parseInt(line.trim()));
        } catch (IOException _) {
            // If reading fails, default bestScore remains zero
        }

        AtomicBoolean isRetryDisplayed = new AtomicBoolean(false);

        //--------------------------------------------------------------------------------------------------------------

        // Setup UI grid of tile labels and configure styles
        Label[][] tileLabels = new Label[4][4];
        GridPane gameGridPane = new GridPane();

        for (int i = 0; i < 4; i++) {
            for (int j = 0; j < 4; j++) {
                tileLabels[i][j] = new Label(String.valueOf(gameBoard.getElement(i, j)));
                tileLabels[i][j].setMinSize(50, 50);
                tileLabels[i][j].setAlignment(Pos.CENTER);
                int val = gameBoard.getElement(i, j);
                tileLabels[i][j].setStyle(
                        "-fx-font-size: 18;" +
                                "-fx-alignment: center;" +
                                "-fx-border-color: black;" +
                                "-fx-border-radius: 8px;" +
                                "-fx-background-color: " + getBackgroundColor(val) + ";" +
                                "-fx-background-radius: 8px;"
                );

                gameGridPane.add(tileLabels[i][j], j, i);
                GridPane.setMargin(tileLabels[i][j], new Insets(0.5));
            }
        }

        //--------------------------------------------------------------------------------------------------------------

        // Initialize score display labels
        Label scoreValueLabel = new Label(String.valueOf(gameBoard.getScore()));
        Label bestScoreValueLabel = new Label(String.valueOf(bestScore.get()));

        Label scoreTitleLabel = new Label("Score:");
        scoreTitleLabel.getStyleClass().add("score-title-label");

        Label bestScoreTitleLabel = new Label("Best score:");
        bestScoreTitleLabel.getStyleClass().add("score-title-label");

        HBox scoreBox = new HBox(scoreTitleLabel, scoreValueLabel, bestScoreTitleLabel, bestScoreValueLabel);
        scoreBox.setSpacing(5);
        scoreBox.setAlignment(Pos.CENTER_RIGHT);
        scoreBox.setPadding(new Insets(5, 10, 5, 10));
        scoreBox.getStyleClass().add("score-box");

        //--------------------------------------------------------------------------------------------------------------

        // Configure New Game button with hover cursor and click handler
        Button newGameBtn = new Button("New game");
        newGameBtn.getStyleClass().add("new-game-button");
        newGameBtn.setCursor(hoverCursor);

        newGameBtn.setOnAction(events -> {
            gameBoard.reset();
            updateGrid(gameBoard, tileLabels);
            scoreValueLabel.setText("0");
            isRetryDisplayed.set(false);
            gameScene.getRoot().requestFocus();

        });


        HBox newGameBox = new HBox(newGameBtn);
        newGameBox.setSpacing(5);
        newGameBox.setAlignment(Pos.CENTER_LEFT);
        newGameBox.setPadding(new Insets(5, 10, 5, 10));

        //--------------------------------------------------------------------------------------------------------------

        // Layout margins for top bar components
        double horizontalPadding = primaryStage.getWidth() * 0.1;
        BorderPane.setMargin(newGameBox, new Insets(10, 0, 0, horizontalPadding));
        BorderPane.setMargin(scoreBox, new Insets(10, horizontalPadding, 0, 0));

        BorderPane headerPane = new BorderPane ();
        headerPane.setLeft(newGameBox);
        headerPane.setRight(scoreBox);

        //--------------------------------------------------------------------------------------------------------------

        // Center the grid container horizontally with padding
        StackPane gridContainer = new StackPane(gameGridPane);
        gridContainer.setPadding(
                new Insets(
                        40,
                        (primaryStage.getWidth()-200)/2,
                        0,
                        (primaryStage.getWidth()-200)/2
                )
        );
        mainLayout.setTop(headerPane);
        mainLayout.setCenter(gridContainer);

        //--------------------------------------------------------------------------------------------------------------

        // Handle key press events for tile movement
        gameScene.setOnKeyPressed((KeyEvent event) -> {

            if(!gameBoard.failedGame()){
                if (event.getCode() == KeyCode.UP) {
                    gameBoard.shift(GameBoard.SHIFT.UP);
                } else if (event.getCode() == KeyCode.DOWN) {
                    gameBoard.shift(GameBoard.SHIFT.DOWN);
                } else if (event.getCode() == KeyCode.LEFT) {
                    gameBoard.shift(GameBoard.SHIFT.LEFT);
                } else if (event.getCode() == KeyCode.RIGHT) {
                    gameBoard.shift(GameBoard.SHIFT.RIGHT);
                }
            }

            // Update score label and grid UI after shift
            scoreValueLabel.setText(String.valueOf(gameBoard.getScore()));
            updateGrid(gameBoard, tileLabels);

            // Update and persist best score if current score exceeds it
            if(bestScore.get() < gameBoard.getScore()){
                bestScore.set(gameBoard.getScore());
                bestScoreValueLabel.setText(String.valueOf(bestScore));
                try (BufferedWriter writer =
                             new BufferedWriter(new FileWriter("resources/data/best_score.txt")))
                {
                    writer.write(String.valueOf(bestScore.get()));
                } catch (IOException e) {
                    throw new RuntimeException(e);
                }
            }

            // If game lost and retry button not shown, show overlay with retry option
            if (gameBoard.failedGame() && !isRetryDisplayed.get()) {
                isRetryDisplayed.set(true);

                Button retryBtn = new Button("Retry");
                retryBtn.getStyleClass().add("retry-button");
                retryBtn.setCursor(hoverCursor);

                StackPane overlay = new StackPane();
                overlay.getStyleClass().add("overlay");
                overlay.setPrefSize(gameScene.getWidth(), gameScene.getHeight());
                overlay.setAlignment(Pos.CENTER);
                overlay.getChildren().add(retryBtn);

                retryBtn.setOnAction(events -> {
                    gameBoard.reset();

                    updateGrid(gameBoard, tileLabels);
                    scoreValueLabel.setText("0");
                    root.getChildren().remove(overlay);
                    isRetryDisplayed.set(false);
                    gameScene.getRoot().requestFocus();
                });

                root.getChildren().add(overlay);
                retryBtn.requestFocus();
            }

        });


    }

    /**
     * Updates the UI grid labels to reflect the current state of the game board
     * Each label's text and background color are updated based on the tile value
     *
     * @param board  the current game board instance
     * @param labels 2D array of Labels representing the tile UI elements
     */
    private void updateGrid(GameBoard board, Label[][] labels){
        for (int i = 0; i < 4; i++) {
            for (int j = 0; j < 4; j++) {
                int val = board.getElement(i, j);
                labels[i][j].setText(String.valueOf(val));
                labels[i][j].setStyle(
                        "-fx-font-size: 18;" +
                                "-fx-alignment: center;" +
                                "-fx-border-color: black;" +
                                "-fx-border-radius: 8px;" +
                                "-fx-background-color: " + getBackgroundColor(val) + ";" +
                                "-fx-background-radius: 8px;"
                );
            }
        }
    }
}




















































































































































































































































































/*
               @@@@%%%@@@@@@
            @@#=:::::----==+#%@@@
          @%+-----------------==*@@@
         @#---------------------=#=*%@
        @*----------------------+#-==+#@@
       @#=----------------------=%=---=+#@@
      @@+#=----------------------#*-----==#@
      @%==#----------------------=#------==+%@
      @#=-#+----------------------**-------=+#@
      @*=-=#=---------------------+#=-------==*@@
      @*---*+----------------------*+--------==*%@
      @*---=#=---------------------+#----------=+%@
      @*----*#----------------------#+----------=+%@
      @#=----#=---------------------+%----------==+@@
      @%=----=%=---------------------%+----------==+@@
      @%=-----+#---------------------+%-----------==+@@
      @@+------**---------------------%*-----------==*@
       @*------=#+--------------------+#------------=+#@
       @%-------+#--------------------=#+------------=+%@
       @@+-------**--------------------+#------------==*@
        @%--------#+-------------------=#=------------==#@
        @@+--------%=-------------------*#-------------==%@
         @#--------=#=------------------=%=------------==+@@
         @%=--------+*-------------------##-------------==#@
          @*---------*+------------------=@=------------==+%@
          @%+--------=#-------------------#*-------------==#@
           @#---------=%------------------=%=------------==+%
            %=---------+#------------------%*-------------==#@
            @%----------+*-----------------+#=------------===@@
             @*----------*+----------------=#+-------------==*@
             @@=---------=#=----------------*#-------------==+@@
              @#----------=#----------------=#=------------===#@
               @*----------+#----------------*#-------------==*@
               @%=----------**---------------=%=------------==+%@
                @%-----------**---------------#*------------===#@
                 @%----------=*=--------------=%------------===*@
                  @#----------=*=--------------#*------------==*%
                   @#----------+*--------------=#=-----------==+%
                   @@*----------+#--------------**-----------===#@
                    @@+----------+*-------------=#=----------===#@
                     @@=----------+*-------------*+-----------==+@@@@@@@@@@@@@@
                       @+---------=*+---===------+*-----------==+@============+*#%%@@@@
                        %+---------=#=============#=---------====@===================+*#%@@@
                        @%+-------===#============+%---------====@+=======================+*#@@@
                          @#---=======*============#+============@+============================+#@@
                           @%=======================%============@+===============================+#@@
                            @%*=====================++===========@+==================================*%@@
                              @##================================@=====================================+#%@
                             @%*================================+%=======================================+*%@
                           @@*==================================+*==========================================#@@
                          @%=-------------===================================================================+%@
                        @@*----------------====================================================================*@@              @@@@
                       @%+------------------====================================================================+%@          @@#+-+@
                      @%---------------------===============================================================+#*++#@@      @%*=----*@
                     @#---:.-----------------==============================================================%#======#@  @@#=-------#@
                    @#=---:------------------=======================================+%*+#%#+=============+%+========#@%====------=%@
                   @%=-----------------------======================================*@:...:#%#+===========#*=================-----*@
                  @%=------------------------======================================%#:....*%%@+=========+#====================--=#@
                 @@=------------------------=======================================#%#=-=*%%%%@+========#*=======================%@
                 @+-------------------------=======================================*@%%%%%%%%%%%========%======================*@@@
                @#-------------------------=====+*#%#*+=============================%%%%%%%%%%%%+======*%==========================#%%@
               @%+-------------------------====*%=...=##+============================%%%%######%*======%*===========================--=*#@@
               @#=------------------------=====@*.....+%@#===========================+%##*****#%+======@===========================-------=*%@@
               @*------------------------=====+@*:...:*%%%#+==========================+%#****+%#=======@==========================------------=#@@
              @%+-----------------------=======%%#+=+#%%%%@*============================+%%#%%+=======+@==========================----------------#@@
              @%==--------------------=========*@%%%%%%%%%%%+==================*======================+@=========================-----------------+%@
              @#===------------------===========%%%%%%%###%@+==================+======================+@=========================-------------+#%@
              @*====-=*#######*=---=============+%%########%+=========%+==============================+@=========================---------=*%@@
             @@+===*#=---------=+#%*=============+%##*****#%+==========================================@==========================-----*%%@
             @@+=+@+=----------=====*%#+===========*%#####%+===========================================@============================#@@
             @@++%+====================*%*============+**+=====================+++=+##****++++*#####**+%#======================+#%@@
 @@@@@@@@@@@@@@**#=======================+##+============================+**++=--::::::::::::::::::::-=*%====================#@@
@%+-:------===++###%#*+=====================##========================*%#=-::::-:--:::::::::::::::::::::#+==================+*@@
 @*-------------------=======================+%+===================+%*--::::::::::::::::::::::::::::::::-#================++++%@
  @#--------------------=======================##===============+%#-::::::::::::::::::::::::::::::::::::-*+=============+++++++@@
   @@=-------------------=======================+#+==========+**=::::::::::::::::::::::::::::::::::::::::=#===========+++++++++#@@
    @@*------------------=========================#========+#+-:::::::::::::::::::::::::::::::::::::::::::=%========+%#*++++++++@@
      @%*--------------============================%+====+#+---::::::::::::::::::::::::::::::::::::::::::::-%+===+++#@@@@@%#*+++%@
        @@+-------=================================+%+==**-:::::::::::::::::::::::::::::::::::::::::::::::::-*#++++%@       @@@@@@
          @%+---====================================+#*#-::::::::::::::::::::::::::::::::::::::::::::::::---==+#%%@@
           @@%++=====================================*#-::::::::::::::::::::::::::::::::::::::::::::::---======+%@
            @@#======================================+*-:::::::::::::::::::::::::::::=+**=::::::::::--=======+#@@
           @#=-=======================================#=::::::::::::::::::::::::::-*%##==%%+:::::---========#@@
         @%=-----------===============================*+:::::::::::::::::::::::::=#=-=#--+**+---=========+#@@
       @@*--------------===============================#::::::::::::::::::::::::+#---==--==-#+=========+#@@
      @#=----------------==============================#::::::::::::::::::::::-%+-----------*#=======+%@@
     @*------------------=================*===========+#:::::::::::::::::::::=#+------------=%====+#%@
   @@+--------------------================@===========*+::::::::::::--------=%+-------------=%=+#%@@                   @@@%##%@@
  @%=-------------------------------=====*%++=========#=-------------======+%+--------------=%@@@                @@@@%#**+**#*+*@@
 @%=-::---------------------------------=%#++++++++++*#===================*%=---------------+%@@@@         @@@@%%#*********#*++##%
@%=----------------=++*#%#--------------=%+++++++++++#+=================+##=-------------===#%##%%%%%%%%%%%##**************+++##*@@
@%****+****##%%%%@@@@@   @*-------------*%+++++++++*%+=================+%*=------------====+%#**********************+++++++++**+#@
                          @%-----------=%@@@%**+*#%*==================*%+==-----===========*%#**********************+++++++++*+#@
                           @@+---------*@    @@@@@%#*+++++++++++++*##%#===-----===========+%#***********************+++++++++*%@
                             @#-------=@@            @@@@%#**#*****#%+===-----============*%#***********************++++++++#%@
                              @%*-----%@                 %*+*****#%+===-----=============+%*%#**********************++++++*%@@
                                @%+--%@                  @#++++##+===-----===============@+=+#@#**********************+*#%@
                                  @@@@                   @%+========----================%======#%##******************#@@@
                                                         @%+=======----================#+:---=*#%*=*#%#**********#%@@@
                                                         @%+======---=================#+:::-**--*+---+%%##**##%%@@@
                                                         @@*====----=================%=:::=#=---*+---+#-#%%@@@@
                                                          @*====----===============*%-:::=#-----=----++--#+=#@@                                     @@
                                                          @*==------=============+%+::::+#---------------=#-:-*@@                                @%##=+@@
                                                          @#==------===========+##-::::+*-----------------*#::::*%@                           @@%=-=*=-#%@
                                                          @%==-------=========**+#::::=#=----------------==%-:::::*%@                      @@%*=---=*--*+*@
                                                          @%=---------===========#=::-#+==---------------==*#::::::-*@                @@@@%*+==--------+-+%
                                                          @@=----------==========++::##===--------------====%-:::::::-#@           @@@%*+=========-------+@
                                                           @+----------===========#=+#====-------------=====%-:::::::::+%@     @@%#+=====================*@
                                                           @#----------===========*#%=====------------======%=::::::::::=%@ @@%#*+++++++++==============+#@
                                                           @%----------===========+%+=====----------========%=:::::::::::=@@%**+*++++*++++++++++++++++++*%@
                                                           @@---------============#*=======-------==========%=::::::::::::+%*****+++*++++++++++++++++++*#@
                                                            @+--------===========+#==========-==============%-::::::::::::-##*+++++++++++++++++++++++++*@@
                                                            @%-------============#+========================+@-::::::::::::-+#*+++++++++++++++****+++++*%@
                                                             @=-----============+#=========================#*:::::::::::--=+#*+++++++++++++++++++++++*%@
                                                             @#--===============#+========================+%-:::::::::--====*#*+++++++++++++++++++++*%@
                                                             @%+================%=========================#+:::::::---======*#*++++++++++++++++++++*%@
                                                              @*===============+*========================*#-::::::--========*#*+++++++++++++++++++*%@
                                                              @%+==============#+=======================+#=:::----==========*#*++++++++++++++++++*@@
                                                              @@#==============*========================%=:----=============##*++++++++++++++++*#@@
                                                               @@+====================================+%+--=================##++++++++++++++++*%@
                                                                @@=================================++*%+===================+%*+++++++++++++++#@@
                                                                 @%==========================++++++*%#+====================+%*+++++++++++++*%@
                                                                  @%+==============++++++++++++++*#%*======================##++++++++++++*%@
                                                                   @%*+++++++++++++++++++++++++*#%#=======================+%*+++**+*+++*#@@
                                                                    @%*+++++++++++++++++++++++#%#+========================%#+++++++++*%@@
                                                                     @@#++++++++++++++++++++++*#+========================#%*+++++++#@@@
                                                                       @%*++++++++++++++++++++%*========================#%++++++*%@@
                                                                        @@%*+++++++++++++++++*@=======================+##*+**#%@@
                                                                          @@#*+++++++++++++++#%======================*%***#%@@
                                                                            @@#*+++++++++++++##============++======+%#%%@@@
                                                                       @@@@@@%%@#*+*+*+++****##===========*++*%*+*%@@@
                                                                @@@@%#*+========+#%#**********@===========#+===+%@
                                                           @@@%#*+=================+#%%#******##==========#*=====+#@
                                                       @@@#*=-::::--===================+**##%%##+=========#+======+*%
                                                   @@@#+--::::::::-:--======================+*+===========#*========+%@
                                                @@@*-:::::::::::::::::--==================+##+============**==========#@
                                            @@@%+-:::::::::::::::::::::::--==============*%+==============*#==========+*@
                                         @@%#+-:::::::::::::::::::::::::::-----========+%*================**============#@
                                       @%*=-::::::::::::::::::::::::::::-:::::-----===##+=================**=============#@
                                    @@#=-:::::::::::::::::::----------::---:::-:::::=%*-==================#*==============#@
                                  @%+:::::::::::::::::::::::::::::::::::::::::::::-#*:::::----============**==============-%@
                               @@#=:::::::::::::::::::::::::::::::::::::::::::::-+#=::::::::::::--------==**=--------------=%@
                             @%*-::::::::::::::::::::::::::::::::::::::::::::::=%+::::::::::::::::::::::--*+----------------#@
                           @@+-::::::::::::::::::::::::::::::::::::::::::::::=#*-:::::::::::::::::::::::::*=:::::::::::::::-+@
                         @@*-:::::::::::::::::::::::::::::::::::::::::::::::*#-::::::::::::::::::::::::::-#-::::::::::::::::=%@
                       @@#-::::::::::::::::::::::::::::::::::::::::::::::-*%-::::::::::::::::::::::::::::=*-::::::::::::::::=%@
                     @@%=::::::::::::::::::::::::::::::::::::::::::::::-+#=::::::::::::::::::::::::::::::++:::::::::::::::::=%@
                    @%+:::::::::::::::::::::::::::::::::::::::::::::::+#=:::::::::::::::::::::::::::::::-*+:::::::::::::::::=%@
                   @#-::::::::::::::::::::::::::::::::::::::::::::::+#=:::::::::::::::::::::::::::::::::-#-:::::::::::::::::+%@
                 @@+::::::::::::::::::::::::::::::::::::::::::::::-#=:::::::::::::::::::::::::::::::::::=*::::::::::::::::::*@
                @#::::::::::::::::::::::::::::::::::::::::::::::-%+:::::::::::::::::::::::::::::::::::::*+:::::::::::::::::-%@
               @*:::::::::::::::::::::::::::::::::::::::::::::-*=::::::::::::::::::::::::::::::::::::::-%-:::::::::::::::::*@
              @*::::::::::::::::::::::::::::::::::::::::::::-*+::::::::::::::::::::::::::::::::::::::::#*:::::::::::::::::*@
             @*:::::::::::::::::::::::::::::::::::::::::::-+-:::::::::::::::::::::::::::::::::::::::::-@-::::::::::::::::*@
            @*:::::::::::::::::::::::::::::::::::::::::::+::::::::::::::::::::::::::::::::::::::::::::#+:::::::::::::::-#@
           @#-:::::::::::::::::::::::::::::::::::::::::-:::::::::::::::::::::::::::::::::::::::::::::=%:::::::::::::::=%@
           @+:::::::::::::::::::::::::::::::::::::::=-::::::::::::::::::::::::::::::::::::::::::::::-#=:::::::::::::-#@@
          @%=::::::::::::::::::::::::::::::::::::-+=::::::::::::::::::::::::::::::::::::::::::::::::+*-:::::::::::-+%@
           %=::::::::::::::::::::::::::::::::::-#+:::::::::::::::::::::::::::::::::::::::::::::::::-#=:::::::::::=%@@
           @+::::::::::::::::::::::::::::::::=%=:::::::::::::::::::::::::::::::::::::::::::::::::::#+::::::::::-%@
           @%-:::::::::::::::::::::::::::::=#=::::::::::::::::::::::::::::::::::::::::::::::::::::#*:::::::::=#@@
            @#:::::::::::::::::::::::::::+#=:::::::::::::::::::::::::::::::::::::::::::::::::::::**::::::::+%@@
             @*:::::::::::::::::::::::-**-::::::::::::::::::::::::::::::::::::::::::::::::::::::++::::::-*%@@
              @#::::::::::::::::::::-#*::::::::::::::::::::::::::::::::::::::::::::::::::::::::=+:::::*@@@
               @%+::::::::::::::::+#+::::::::::::::::::::::::::::::::::::::::::::::::::::::::::-::-*%@@
                 @%=:::::::::::-##-::::::::::::::::::::::::::::::::::::::::::::::::::::::::::--+#@@
                   @%+-::::::+#+-:::::::::::::::::::::::::::::::::::::::::::::::::::::::::-+#@@@
                     @@%+::=+-:::::::::::::::::::::::::::::::::::::::::::::::::::::::-+#%@@@
                        @@%#=::::::::::::::::::::::::::::::::::::::::::::::::::=+#%@@@@
                             @@@%#+=--:::::::::::::::::::::::::::::--==+*#%@@@@
                                   @@@@@@@@%%######%%%%%%@@@@@@@@@@@@
 */